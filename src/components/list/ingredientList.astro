---
import Layout from "../../layouts/Layout.astro";
import "../../styles/global.css";
import { db } from "../../lib/db.ts";

const url = new URL(Astro.request.url);
const selectedIngredientIds = url.searchParams.getAll("ingredients").map(id => Number(id));

// Consulta ingredientes con JOIN a Ingredient_Types
const ingredientesSeleccionados = await db
  .selectFrom("ingredients")
  .innerJoin("Ingredient_Types", "ingredients.ingType_ID", "Ingredient_Types.ingType_ID")
  .select([
    "ingredients.ingredient_ID",
    "ingredients.nombre_Ingrediente",
    "ingredients.porcion_Ingrediente",
    "ingredients.unidad_Ingrediente",
    "ingredients.ingType_ID",
    "Ingredient_Types.ingType_Name"
  ])
  .where("ingredients.ingredient_ID", "in", selectedIngredientIds)
  .execute();

// Agrupa por tipo con claves como string
const ingredientesPorTipo = ingredientesSeleccionados.reduce((acc, ing) => {
  const key = String(ing.ingType_ID);
  if (!acc[key]) acc[key] = [];
  acc[key].push(ing);
  return acc;
}, {});
---

<Layout>
  <div class="py-10 text-center bg-gradient-to-tr from-black to-purple-700 text-white">
    <h1 class="text-4xl font-bold">Menú Semanal</h1>
    <button id="generate-btn" class="mt-6 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-full font-semibold transition">
      Generar menú aleatorio
    </button>
  </div>

  <div id="menu-output" class="max-w-4xl mx-auto mt-10 px-4 space-y-6">
  {Object.entries(ingredientesPorTipo).map(([tipoID, grupo]) => (
    <section class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-semibold text-purple-700 mb-4">
        {grupo[0].ingType_Name}
      </h2>
      <ul class="list-disc list-inside space-y-2">
        {grupo.map(ing => (
          <li key={ing.ingredient_ID} class="text-gray-800">
            {ing.nombre_Ingrediente} — {ing.porcion_Ingrediente} {ing.unidad_Ingrediente}(s)
          </li>
        ))}
      </ul>
    </section>
  ))}
</div>


  <script id="ingredientes-data" type="application/json">
    {JSON.stringify(ingredientesPorTipo)}
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("generate-btn");
      const output = document.getElementById("menu-output");
      const rawData = document.getElementById("ingredientes-data").textContent;
      const ingredientesPorTipo = JSON.parse(rawData);

      btn.addEventListener("click", () => {
        output.innerHTML = "<p class='text-gray-700'>Generando menú...</p>";
        // Aquí irá la lógica para generar el menú
      });
    });
  </script>
</Layout>
